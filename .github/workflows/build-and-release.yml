# .github/workflows/build-and-release.yml

name: Build Android APK and Release

# This workflow will run when a new tag matching 'release/*' is pushed.
on:
  push:
    tags:
      - 'release/*'

jobs:
  build_and_release:
    runs-on: ubuntu-latest # Use a Linux runner for the build process

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch all history for all tags and branches, which is needed for release actions
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x' # Or your preferred LTS Node.js version (e.g., '20.x')
          cache: 'npm' # Cache npm dependencies for faster builds

      - name: Install dependencies
        run: npm install --force # Use --force if you encounter peer dependency issues

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: Login to Expo
        # This step uses your Expo API token from GitHub Secrets.
        # Make sure you have set EXPO_TOKEN in your repository's secrets.
        run: eas login --token ${{ secrets.EXPO_TOKEN }}

      - name: Build Android APK with EAS
        # --platform android: Specifies to build for Android.
        # --profile production: Uses the 'production' build profile defined in eas.json.
        # --non-interactive: Runs the command without prompting for user input.
        # --output=app.apk: Specifies the local filename for the output APK.
        run: eas build --platform android --profile production --non-interactive --output=app.apk

      - name: Get tag name
        id: get_tag
        run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release and Upload APK
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/') # Ensure this only runs on tag pushes
        with:
          # Uses the current tag name as the release tag
          tag_name: ${{ steps.get_tag.outputs.TAG_NAME }}
          # Generates a release name based on the tag
          name: Release ${{ steps.get_tag.outputs.TAG_NAME }}
          # A brief description for the release. You can customize this.
          body: |
            ## New Android APK Release
            This release includes the latest Android application bundle.
            - Version: ${{ steps.get_tag.outputs.TAG_NAME }}
            - Built via GitHub Actions.
          draft: false # Set to true if you want to manually publish the release later
          prerelease: false # Set to true if this is a pre-release (e.g., alpha, beta)
          # Path to the APK file generated by EAS
          files: app.apk
        env:
          # GITHUB_TOKEN is automatically provided by GitHub Actions for authentication
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}